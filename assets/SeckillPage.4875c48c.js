import{defineComponent as B,ref as l,onMounted as R,computed as b,openBlock as w,createElementBlock as k,toDisplayString as h,unref as E,reactive as L,onBeforeMount as M,createElementVNode as e,createTextVNode as g,createBlock as P,createCommentVNode as D,normalizeClass as U,pushScopeId as O,popScopeId as x}from"https://esm.sh/vue@^3.2.41";import{u as N,M as S}from"./customer.143a0fc3.js";import{u as H,a as V,T as K}from"./settings.fa8ead99.js";import{useRouter as z}from"https://esm.sh/vue-router@^4.1.6";import{_ as $}from"./index.b5b41545.js";import"https://esm.sh/pinia@^2.0.23";import"https://esm.sh/axios@^1.1.2";import"https://esm.run/js-sha256@^0.9.0";import"https://esm.sh/js-cookie@^3.0.1";const j=B({__name:"CountDown",props:{remainTime:{type:Number,default:0}},emits:["count-down-end"],setup(v,{emit:r}){const _=v,o=l(0),a=l(0),t=l(0),i=l(0);R(()=>{if(_.remainTime>0){o.value=Math.floor(_.remainTime/3600),a.value=Math.floor(_.remainTime/60%60),t.value=Math.floor(_.remainTime%60),m();return}r("count-down-end")});const m=()=>{clearInterval(i.value),i.value=setInterval(()=>{o.value===0?a.value!==0&&t.value===0?(t.value=59,a.value-=1):a.value===0&&t.value===0?(t.value=0,r("count-down-end"),clearInterval(i.value)):t.value-=1:a.value!==0&&t.value===0?(t.value=59,a.value-=1):a.value===0&&t.value===0?(o.value-=1,a.value=59,t.value=59):t.value-=1},1e3)},d=f=>f<10?"0"+f:""+f,p=b(()=>d(o.value)),u=b(()=>d(a.value)),y=b(()=>d(t.value));return(f,A)=>(w(),k("span",null,h(E(p)+":"+E(u)+":"+E(y)),1))}}),c=v=>(O("data-v-c66b83db"),v=v(),x(),v),q={class:"header"},G=c(()=>e("div",{class:"left-block"},null,-1)),J=c(()=>e("div",{class:"title"},[e("p",null,"Lingyuangou")],-1)),Q=c(()=>e("div",{class:"right-block"},null,-1)),W={class:"account-bar"},X=c(()=>e("div",{class:"account-info"},null,-1)),Y={class:"account-name"},Z={class:"content"},ee={key:0,class:"seckill-form"},te={class:"information"},oe=c(()=>e("br",null,null,-1)),ae=c(()=>e("br",null,null,-1)),ne={class:"time"},ue={class:"button-view"},se={key:1,class:"seckill-success-form"},le=c(()=>e("div",{class:"order-info-title"},"\u8BA2\u5355\u4FE1\u606F",-1)),ce={class:"order-info"},re=c(()=>e("br",null,null,-1)),ie=B({__name:"SeckillPage",setup(v){const r=z(),_=N(),o=H(),a=V(),t=l({}),i=l({product:{},rule:{}}),m=l(""),d=l(!1),p=l({}),u=L({remainSeconds:0,display:!1,end:!0}),y=b(()=>m.value!==""&&u.end);M(async()=>{K.verify()||await r.push("/");let n=await _.getInfo(),s=await o.getCurrent();if((n.code!==200||s.code!==200)&&await r.push("/"),t.value=n.data,i.value=s.data,!t.value.applied){console.warn("\u7528\u6237\u672A\u7533\u8BF7\u6D3B\u52A8\uFF01"),await r.push("/apply");return}u.remainSeconds=(await o.getCountDown()).data,u.display=!0;let F=setInterval(async()=>{if(u.end){let C=await o.getSeckillUrl();C.code===200&&(m.value=C.data,console.log("\u83B7\u53D6\u5230\u79D2\u6740\u94FE\u63A5\uFF1A"+m.value),clearInterval(F))}},1e3)});const f=async()=>{if(!y.value){await alert(S.SECKILL_NOT_STARTED);return}let n=await o.seckill(m.value);if(n.code===500&&(alert(n.message),n.message!==S.PURCHASE_REPEAT))return;n.code===200&&await alert(S.SECKILL_SUCCESS);let s=await o.getOrder();if(s.code===500)return;const{putOrderSuccess:F}=s.data;if(!F){await alert(S.PUT_ORDER_FAILED);return}p.value=s.data,d.value=!0},A=async()=>{let n=await o.pay(p.value.orderId);if(n.code===500)return;const{paymentSuccess:s}=n.data;await alert(s?S.PURCHASE_SUCCESS:S.PURCHASE_FAILED)},I=()=>{u.end=!0},T=()=>{a.logout(),r.push("/")};return(n,s)=>(w(),k("div",null,[e("div",q,[G,J,Q,e("div",W,[X,e("div",Y,h(t.value.name),1),e("div",{class:"log-out",onClick:T},"\u9000\u51FA\u767B\u5F55")])]),e("div",Z,[d.value?D("",!0):(w(),k("div",ee,[e("div",te,[g(h(i.value.product.name)+" ",1),oe,ae,g(" \u5E93\u5B58\u603B\u91CF\uFF1A"+h(i.value.amount)+"\u4EFD ",1)]),e("div",ne,[g(" \u6D3B\u52A8\u5012\u8BA1\u65F6: "),u.display?(w(),P(j,{key:0,"remain-time":u.remainSeconds,onCountDownEnd:I},null,8,["remain-time"])):D("",!0)]),e("div",ue,[e("button",{onClick:f,class:U({"enter-button":!0,disabled:!E(y)})},"\u79D2\u6740",2)])])),d.value?(w(),k("div",se,[le,e("div",ce,[g(" \u8BA2\u5355\u7F16\u53F7\uFF1A"+h(p.value.orderId),1),re,g(" \u8BA2\u5355\u91D1\u989D\uFF1A"+h(p.value.money)+"\u5143 ",1)]),e("div",{class:"button-view"},[e("button",{onClick:A,class:"enter-button"},"\u4ED8\u6B3E")])])):D("",!0)])]))}});const we=$(ie,[["__scopeId","data-v-c66b83db"]]);export{we as default};
